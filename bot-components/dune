(library
 (name Bot_components)
 (public_name bot-components)
 (libraries base cohttp-lwt-unix hex nocrypto stdio str yojson)
 (preprocess
  (pps graphql_ppx -- -schema bot-components/schema.json))
 (preprocessor_deps
  (file schema.json)))

(rule
 (targets schema.json)
 (deps
  (:input .graphqlconfig.in)
  .github-token
  (universe))
 (action
  (progn
   (with-stdout-to
    .graphqlconfig
    (run sed "s/%%TOKEN%%/%{read:.github-token}/" %{input}))
   (run graphql get-schema)
   (run sed -i "s/\"timestamp\": \".*\"/\"timestamp\": \"\"/" %{targets})))
 (mode promote))

(env
 (dev
  (flags :standard -w -9)))
